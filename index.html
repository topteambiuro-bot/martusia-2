<script>
    // ... (stałe targetPos, loveNotes itd. zostają bez zmian) ...

    function startGps() {
        // 1. Prośba o dostęp do kompasu (wymagane na iPhone/iOS)
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(permissionState => {
                    if (permissionState === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation, true);
                    }
                })
                .catch(console.error);
        } else {
            // Android i inne
            window.addEventListener('deviceorientation', handleOrientation, true);
        }

        // 2. Śledzenie pozycji GPS
        navigator.geolocation.watchPosition(pos => {
            const userLat = pos.coords.latitude;
            const userLon = pos.coords.longitude;

            const d = calcDist(userLat, userLon, targetPos.lat, targetPos.lon);
            // Obliczamy kąt do celu (bearing)
            currentBearingToTarget = calcBear(userLat, userLon, targetPos.lat, targetPos.lon);

            document.getElementById('distance').innerText = Math.round(d);
            
            if(d < 15) next('final');
        }, (err) => { 
            alert("Włącz GPS, aby namierzyć prezent! ❤️"); 
        }, {enableHighAccuracy: true});
    }

    let currentBearingToTarget = 0;
    let deviceHeading = 0;

    function handleOrientation(event) {
        // Pobieramy kierunek, w którym patrzy telefon (heading)
        // webkitCompassHeading dla iOS, alpha dla Androida (z poprawką)
        if (event.webkitCompassHeading) {
            deviceHeading = event.webkitCompassHeading;
        } else {
            deviceHeading = 360 - event.alpha;
        }

        // Strzałka musi wskazywać: (Kąt do celu) - (Kierunek telefonu)
        const arrowRotation = currentBearingToTarget - deviceHeading;
        const arrowElement = document.getElementById('arrow');
        
        // Płynny obrót
        arrowElement.style.transform = `rotate(${arrowRotation}deg)`;
    }

    function calcDist(l1, o1, l2, o2) {
        const R = 6371000;
        const dL = (l2-l1)*Math.PI/180, dO = (o2-o1)*Math.PI/180;
        const a = Math.sin(dL/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dO/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function calcBear(l1, o1, l2, o2) {
        const lat1 = l1 * Math.PI / 180;
        const lat2 = l2 * Math.PI / 180;
        const dLon = (o2 - o1) * Math.PI / 180;

        const y = Math.sin(dLon) * Math.cos(lat2);
        const x = Math.cos(lat1) * Math.sin(lat2) -
                  Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
        
        return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
    }
</script>
