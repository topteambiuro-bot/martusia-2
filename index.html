<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Misja: Serce</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #ff2d55;
            --accent: #ffb3c1;
            --bg: #0a0204;
            --glass: rgba(255, 255, 255, 0.05);
            --glow: 0 0 20px rgba(255, 45, 85, 0.5);
        }

        /* Pasek Postƒôpu */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); z-index: 2000; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), #ff5e7e); box-shadow: 0 0 15px var(--primary); transition: width 0.6s ease; }
        #step-counter { position: fixed; top: 15px; right: 15px; font-size: 0.7rem; color: var(--accent); letter-spacing: 1px; z-index: 2000; opacity: 0.8; }

        body { margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; text-align: center; overflow: hidden; }
        
        .screen { display: none; width: 85%; max-width: 400px; padding: 30px 20px; background: var(--glass); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); z-index: 10; flex-direction: column; align-items: center; position: relative; }
        .active { display: flex; }

        h1 { font-size: 1.2rem; text-transform: uppercase; letter-spacing: 4px; color: var(--accent); margin-bottom: 20px; text-shadow: var(--glow); }
        .btn-main { background: linear-gradient(45deg, var(--primary), #ff5e7e); border: none; color: white; padding: 16px 35px; border-radius: 50px; font-weight: bold; text-transform: uppercase; cursor: pointer; margin-top: 20px; }
        input { background: rgba(0,0,0,0.3); border: 1px solid var(--primary); color: white; padding: 15px; border-radius: 15px; text-align: center; width: 80%; margin-top: 15px; outline: none; }

        /* Styl Mapy */
        #map { width: 100%; height: 300px; border-radius: 20px; margin: 15px 0; border: 2px solid var(--primary); box-shadow: var(--glow); z-index: 5; }
        #dist-val { font-size: 2rem; font-weight: 900; color: var(--primary); }

        /* Gry pomocnicze */
        #petal-area { position: relative; width: 280px; height: 280px; background: rgba(0,0,0,0.2); border-radius: 50%; }
        .petal { position: absolute; cursor: pointer; font-size: 2rem; transition: 0.4s; }
        .memory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .card { width: 70px; height: 70px; background: rgba(255,255,255,0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .flipped { background: var(--primary); }
    </style>
</head>
<body>

    <div class="progress-container"><div id="progress-bar"></div></div>
    <div id="step-counter">KROK 1 / 7</div>

    <div id="step1" class="screen active">
        <h1>Pr√≥ba Amora</h1>
        <canvas id="amor-canvas" width="300" height="250"></canvas>
    </div>

    <div id="step-flappy" class="screen">
        <h1>Lot Serca</h1>
        <canvas id="flappy-canvas" width="300" height="300"></canvas>
    </div>

    <div id="step2" class="screen">
        <h1>Ogr√≥d Wspomnie≈Ñ</h1>
        <div id="petal-area"></div>
    </div>

    <div id="step3" class="screen">
        <h1>Szyfr Serca</h1>
        <p>RUDE KOCHANE STWORZENIE?</p>
        <input type="text" id="answerInput" placeholder="Odpowied≈∫...">
        <button class="btn-main" onclick="checkAnswer()">Dalej</button>
    </div>

    <div id="step4" class="screen">
        <h1>Synchronizacja</h1>
        <div class="memory-grid" id="grid"></div>
    </div>

    <div id="step5" class="screen">
        <h1>Namierzanie...</h1>
        <div id="map"></div>
        <div>Dystans: <span id="dist-val">--</span> m</div>
    </div>

    <div id="final" class="screen">
        <h1>Jeste≈õ u celu! ‚ù§Ô∏è</h1>
        <p>Znajd≈∫ to, co dla Ciebie przygotowa≈Çem.</p>
        <div style="font-size: 60px;">üéÅ</div>
    </div>

    <script>
        // --- KONFIGURACJA ---
        const targetPos = [50.398567, 18.913362]; // [LAT, LON]
        const CORRECT_ANSWER = "pimpek";
        const screens = ['step1', 'step-flappy', 'step2', 'step3', 'step4', 'step5', 'final'];

        let map, userMarker, targetMarker, pathLine;

        function updateProgress(id) {
            const idx = screens.indexOf(id);
            document.getElementById('progress-bar').style.width = ((idx+1)/screens.length)*100 + '%';
            document.getElementById('step-counter').innerText = `KROK ${idx+1} / ${screens.length}`;
        }

        function next(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            updateProgress(id);
            if(id === 'step-flappy') initFlappy();
            if(id === 'step2') initPetals();
            if(id === 'step4') initMemory();
            if(id === 'step5') initMap();
        }

        // --- MAPA ---
        function initMap() {
            if (map) return;
            
            // Inicjalizacja mapy Leaflet
            map = L.map('map').setView(targetPos, 16);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // Ikona prezentu
            const giftIcon = L.divIcon({ html: 'üéÅ', className: 'map-icon', iconSize: [30, 30] });
            targetMarker = L.marker(targetPos, {icon: giftIcon}).addTo(map);

            // Ikona u≈ºytkownika (Twoja dziewczyna)
            userMarker = L.circleMarker([0,0], { color: '#ff2d55', radius: 8, fillOpacity: 1 }).addTo(map);
            pathLine = L.polyline([], {color: '#ff2d55', dashArray: '5, 10', opacity: 0.5}).addTo(map);

            // ≈öledzenie GPS
            navigator.geolocation.watchPosition(pos => {
                const uLat = pos.coords.latitude;
                const uLon = pos.coords.longitude;
                const uPos = [uLat, uLon];

                userMarker.setLatLng(uPos);
                pathLine.setLatLngs([uPos, targetPos]);
                map.panTo(uPos);

                const d = map.distance(uPos, targetPos);
                document.getElementById('dist-val').innerText = Math.round(d);

                if(d < 15) next('final');
            }, err => alert("W≈ÇƒÖcz GPS!"), { enableHighAccuracy: true });
        }

        // --- POZOSTA≈ÅE GRY (SKR√ìCONE DO DZIA≈ÅANIA) ---
        // AMOR
        const aCanv = document.getElementById('amor-canvas'); const aCtx = aCanv.getContext('2d');
        let aH = 0, aArr = null, tH = {x:50, d:2};
        function drawA(){ if(!document.getElementById('step1').classList.contains('active')) return; aCtx.clearRect(0,0,300,250); tH.x+=tH.d; if(tH.x>250||tH.x<10) tH.d*=-1; aCtx.font="30px Arial"; aCtx.fillText("üíñ",tH.x,50); aCtx.fillText("üèπ",135,230); if(aArr){ aArr.y-=7; aCtx.fillText("üíò",aArr.x,aArr.y); if(aArr.y<60 && aArr.x>tH.x-10 && aArr.x<tH.x+30){ aH++; aArr=null; if(aH>=7) next('step-flappy'); } else if(aArr.y<0){ aH=0; aArr=null; } } aCtx.font="14px Arial"; aCtx.fillStyle="white"; aCtx.fillText("Trafienia: "+aH+"/7",10,20); requestAnimationFrame(drawA); }
        aCanv.addEventListener('touchstart', (e)=>{ e.preventDefault(); if(!aArr) aArr={x:135,y:200}; }); drawA();

        // FLAPPY
        const fCanv = document.getElementById('flappy-canvas'); const fCtx = fCanv.getContext('2d');
        let fH={y:150,v:0}, fP=[], fS=0;
        function initFlappy(){ fH={y:150,v:0}; fP=[]; fS=0; drawF(); }
        function drawF(){ if(!document.getElementById('step-flappy').classList.contains('active')) return; fCtx.clearRect(0,0,300,300); fH.v+=0.2; fH.y+=fH.v; fCtx.fillText("‚ù§Ô∏è",50,fH.y); if(fP.length==0 || fP[fP.length-1].x < 150) fP.push({x:300,t:Math.random()*150+50}); fP.forEach((p,i)=>{ p.x-=2; fCtx.fillStyle="rgba(255,45,85,0.4)"; fCtx.fillRect(p.x,0,30,p.t); fCtx.fillRect(p.x,p.t+100,30,300); if(p.x==50) fS++; if(fS>=35) next('step2'); if(p.x<50 && p.x>20 && (fH.y<p.t || fH.y>p.t+100)) fS=0; }); requestAnimationFrame(drawF); }
        fCanv.addEventListener('touchstart', (e)=>{ e.preventDefault(); fH.v=-4; });

        // P≈ÅATKI
        function initPetals(){ const area=document.getElementById('petal-area'); area.innerHTML=''; for(let i=0;i<12;i++){ const p=document.createElement('div'); p.className='petal'; p.innerText='üå∏'; p.style.left=Math.random()*230+'px'; p.style.top=Math.random()*230+'px'; p.onclick=()=>{ p.remove(); if(area.children.length==0) next('step3'); }; area.appendChild(p); } }

        // SZYFR
        function checkAnswer(){ if(document.getElementById('answerInput').value.toLowerCase().trim()===CORRECT_ANSWER) next('step4'); else alert("≈πle!"); }

        // MEMORY
        function initMemory(){ const g=document.getElementById('grid'); g.innerHTML=''; let cards=['‚ù§Ô∏è','üî•','üíç','‚ù§Ô∏è','üî•','üíç'].sort(()=>Math.random()-0.5); cards.forEach(c=>{ const d=document.createElement('div'); d.className='card'; d.onclick=()=>{ d.innerText=c; d.classList.add('flipped'); let f=document.querySelectorAll('.flipped:not(.matched)'); if(f.length==2){ if(f[0].innerText==f[1].innerText){ f.forEach(x=>x.classList.add('matched')); if(document.querySelectorAll('.matched').length==6) next('step5'); } else { setTimeout(()=>{ f.forEach(x=>{x.classList.remove('flipped'); x.innerText='';}) },500); } } }; g.appendChild(d); }); }

        updateProgress('step1');
    </script>
</body>
</html>
